<form [formGroup]="form" class="tan-form-content">
  <!-- Loading indicator -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading TAN data...</p>
    </div>
  }

  <!-- Save message -->
  @if (saveMessage()) {
    <div class="save-message" [class.success]="saveMessage()?.includes('success')" [class.error]="saveMessage()?.includes('Failed')">
      <mat-icon>{{ saveMessage()?.includes('success') ? 'check_circle' : 'error' }}</mat-icon>
      <span>{{ saveMessage() }}</span>
    </div>
  }

  <div class="tan-form-content">
  <!-- Sample Preparation Section -->
  <div class="sample-section">
    <h3>Sample Preparation</h3>
    <div class="form-row">
      <mat-form-field class="half-width">
        <mat-label>Sample Weight</mat-label>
        <input matInput type="number" formControlName="sampleWeight"
               step="0.01" min="0.01" max="10.00" placeholder="Weight (g)">
        <mat-hint>Weight should be between 0.01g and 10.00g</mat-hint>
        @if (form.get('sampleWeight')?.hasError('required')) {
          <mat-error>Sample weight is required</mat-error>
        }
        @if (form.get('sampleWeight')?.hasError('min') || form.get('sampleWeight')?.hasError('max')) {
          <mat-error>Weight must be between 0.01-10.00g</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="half-width">
        <mat-label>Test Method</mat-label>
        <mat-select formControlName="testMethod">
          <mat-option value="ASTM-D664">ASTM D664 - Potentiometric</mat-option>
          <mat-option value="ASTM-D974">ASTM D974 - Color Indicator</mat-option>
          <mat-option value="IP-139">IP 139 - Color Indicator</mat-option>
          <mat-option value="ISO-6618">ISO 6618 - Potentiometric</mat-option>
        </mat-select>
        <mat-hint>Standard test method</mat-hint>
      </mat-form-field>
    </div>
  </div>

  <!-- Titration Section -->
  <div class="titration-section">
    <h3>Titration Data</h3>
    <div class="form-row">
      <mat-form-field class="third-width">
        <mat-label>Initial Buret Reading</mat-label>
        <input matInput type="number" formControlName="initialBuret"
               step="0.01" min="0" max="50" placeholder="Initial reading (mL)">
        <mat-hint>Starting buret reading (typically 0)</mat-hint>
        @if (form.get('initialBuret')?.hasError('required')) {
          <mat-error>Initial buret reading is required</mat-error>
        }
        @if (form.get('initialBuret')?.hasError('min') || form.get('initialBuret')?.hasError('max')) {
          <mat-error>Reading must be between 0-50 mL</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="third-width">
        <mat-label>Final Buret Reading</mat-label>
        <input matInput type="number" formControlName="finalBuret"
               step="0.01" min="0" max="50" placeholder="Final reading (mL)">
        <mat-hint>Buret reading after titration</mat-hint>
        @if (form.get('finalBuret')?.hasError('required')) {
          <mat-error>Final buret reading is required</mat-error>
        }
        @if (form.get('finalBuret')?.hasError('min') || form.get('finalBuret')?.hasError('max')) {
          <mat-error>Reading must be between 0-50 mL</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="third-width">
        <mat-label>Net Buret Volume</mat-label>
        <input matInput type="number" [value]="netBuretVolume()" 
               readonly class="calculated-field" placeholder="mL">
        <mat-hint>Automatically calculated: Final - Initial</mat-hint>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field class="third-width">
        <mat-label>KOH Normality</mat-label>
        <input matInput type="number" formControlName="kohNormality"
               step="0.0001" min="0.0001" max="1.0000" placeholder="0.1000 N">
        <mat-hint>Typically around 0.1000 N</mat-hint>
        @if (form.get('kohNormality')?.hasError('required')) {
          <mat-error>KOH normality is required</mat-error>
        }
        @if (form.get('kohNormality')?.hasError('min') || form.get('kohNormality')?.hasError('max')) {
          <mat-error>Normality must be between 0.0001-1.0000 N</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="third-width">
        <mat-label>Solvent System</mat-label>
        <mat-select formControlName="solvent">
          <mat-option value="Isopropanol/Toluene">Isopropanol/Toluene (1:1)</mat-option>
          <mat-option value="Isopropanol/Water">Isopropanol/Water</mat-option>
          <mat-option value="Toluene/Methanol">Toluene/Methanol</mat-option>
          <mat-option value="Other">Other</mat-option>
        </mat-select>
        <mat-hint>Solvent mixture used</mat-hint>
      </mat-form-field>

      <mat-form-field class="third-width">
        <mat-label>Indicator</mat-label>
        <mat-select formControlName="indicator">
          <mat-option value="P-Naphtholbenzein">P-Naphtholbenzein</mat-option>
          <mat-option value="Alkali Blue">Alkali Blue</mat-option>
          <mat-option value="Potentiometric">Potentiometric (no indicator)</mat-option>
          <mat-option value="Other">Other</mat-option>
        </mat-select>
        <mat-hint>Color indicator used</mat-hint>
      </mat-form-field>
    </div>
  </div>

  <!-- Test Conditions Section -->
  <div class="conditions-section">
    <h3>Test Conditions</h3>
    <div class="form-row">
      <mat-form-field class="half-width">
        <mat-label>Temperature</mat-label>
        <input matInput type="number" formControlName="temperature"
               step="0.1" min="15" max="35" placeholder="22 °C">
        <mat-hint>Room temperature during test</mat-hint>
        @if (form.get('temperature')?.hasError('min') || form.get('temperature')?.hasError('max')) {
          <mat-error>Temperature must be between 15-35°C</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="half-width">
        <mat-label>Analyst Initials</mat-label>
        <input matInput formControlName="analystInitials"
               maxlength="5" placeholder="ABC">
        @if (form.get('analystInitials')?.hasError('required')) {
          <mat-error>Analyst initials are required</mat-error>
        }
        @if (form.get('analystInitials')?.hasError('maxlength')) {
          <mat-error>Maximum 5 characters</mat-error>
        }
      </mat-form-field>
    </div>
  </div>

  <!-- Color Indication Section -->
  <div class="color-section">
    <h3>Color Indication</h3>
    <div class="form-row">
      <mat-form-field class="full-width">
        <mat-label>Color Observed</mat-label>
        <input matInput formControlName="colorObserved"
               placeholder="Describe the color change observed at endpoint">
        <mat-hint>e.g., "Light pink to dark green", "Colorless to light pink"</mat-hint>
      </mat-form-field>
    </div>
  </div>

  <!-- Calculation Display -->
  @if (showCalculationDetails() && tanResult()) {
    <div class="calculation-display">
      <h3>Calculation Details</h3>
      <div class="calc-formula">
        <strong>Formula:</strong> TAN = (Net Buret Volume × 56.1 × KOH Normality) / Sample Weight
      </div>
      @if (tanResult()?.isValid) {
        <div class="calc-values">
          <p><strong>Net Volume:</strong> {{ netBuretVolume() | number:'1.2-2' }} mL</p>
          <p><strong>KOH Normality:</strong> {{ form.get('kohNormality')?.value | number:'1.4-4' }} N</p>
          <p><strong>Sample Weight:</strong> {{ form.get('sampleWeight')?.value | number:'1.2-2' }} g</p>
          <p class="calc-result">
            <strong>TAN Result:</strong> {{ tanResult()?.result | number:'1.2-2' }} mg KOH/g
          </p>
          @if (tanResult()?.metadata) {
            <p class="calc-metadata">
              <small>KOH Molecular Weight: {{ tanResult()?.metadata['kohMolecularWeight'] }} g/mol</small>
            </p>
          }
        </div>
      }
    </div>
  }

  <!-- Quality Control Section -->
  @if (showQualityControlChecks()) {
    <div class="qc-section">
      <h3>Quality Control Checks</h3>
      <div class="qc-warnings">
        @if (hasNegativeVolume()) {
          <div class="qc-warning error">
            <mat-icon>error</mat-icon>
            <span>Negative titration volume - check buret readings</span>
          </div>
        }
        @for (warning of getQualityControlWarnings(); track warning) {
          <div class="qc-warning">
            <mat-icon>warning</mat-icon>
            <span>{{ warning }}</span>
          </div>
        }
      </div>
    </div>
  }

  <!-- Observations Section -->
  <div class="observations-section">
    <h3>Test Observations & Comments</h3>
    <div class="form-row">
      <mat-form-field class="full-width">
        <mat-label>Test Notes</mat-label>
        <textarea matInput formControlName="testNotes" rows="2"
                  placeholder="Equipment used, deviations, environmental conditions"></textarea>
        <mat-hint>Note any difficulties, equipment issues, or unusual behavior</mat-hint>
      </mat-form-field>
    </div>

  </div>

  <!-- Action Buttons -->
  <div class="form-actions">
    <button mat-raised-button color="primary" 
            type="button"
            (click)="saveResults()" 
            [disabled]="!form.valid || isSaving() || isLoading()">
      @if (isSaving()) {
        <mat-spinner diameter="20"></mat-spinner>
        <span>Saving...</span>
      } @else {
        <mat-icon>save</mat-icon>
        <span>Save Results</span>
      }
    </button>
    
    <button mat-raised-button 
            type="button"
            (click)="clearForm()" 
            [disabled]="isSaving() || isLoading()">
      <mat-icon>clear</mat-icon>
      <span>Clear Form</span>
    </button>
  </div>
</div>
</form>

